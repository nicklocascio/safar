<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title></title>
        <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
        <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.js'></script>
        <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.css' rel='stylesheet' />
        <style>
            body {
                margin: 0;
                padding: 0;
            }

            #map {
                position: absolute;
                top: 0px;
                bottom: 0;
                width: 100%;
            }
        </style>
    </head>
    <body>
        <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.0/mapbox-gl-directions.js"></script>
        <link
            rel="stylesheet"
            href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.0/mapbox-gl-directions.css"
            type="text/css"
        />
        <script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.auto.min.js"></script> 
        <div id='map'></div>
        <div id="directions" class="directions"></div>

        <script>
            // this makes an api call for points of interest successfully
            url = 'https://api.tomtom.com/search/2/poiSearch/bar.json?lat=45.523&lon=-122.663&radius=1600&categorySet=9379&key=ofA7qZAPku6DpZdRy3h56n5hZZ0g99t9'
            var result;
            fetch(url)
                .then(response => {
                    result = response.json();
                    console.log(result);
                    return result;
                });

            // setting up the map and directions features
            mapboxgl.accessToken = 'pk.eyJ1Ijoic2FmYXJ0ZWFtMjAyMCIsImEiOiJja2dtbHRsbW4wMWtlMnhxbDNheGJ6OWY5In0.sQWD2q6skgQK31V-ip2Ltg';
            var map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/streets-v11',
                center: [-122.662323, 45.523751],
                zoom: 9
            });

            var directions = new MapboxDirections ({
                accessToken: mapboxgl.accessToken,
                mapboxgl: mapboxgl,
                interactive: false
            });

            map.addControl(directions, "top-right");

            var start_location = "";
            var destination = "";
            var origin_coords = 0;
            var dest_coords = 0;
            var count = 0;

            directions.on("route", function(e) {
                console.log(e);

                // reverse geocode origin
                var origin = directions.getOrigin();
                origin_coords = origin.geometry.coordinates;
                var origin_url = 'https://api.mapbox.com/geocoding/v5/mapbox.places/' + origin_coords[0] + ',' + origin_coords[1] + '.json?access_token=pk.eyJ1Ijoic2FmYXJ0ZWFtMjAyMCIsImEiOiJja2dtbHRsbW4wMWtlMnhxbDNheGJ6OWY5In0.sQWD2q6skgQK31V-ip2Ltg';

                function originReqListener() {
                    var json = JSON.parse(this.response);
                    var substring = "place"
                    for(let i = 0; i < json.features.length; i++) {
                        if(json.features[i].id.includes(substring)) {
                            start_location = json.features[3].place_name;
                            break;
                        }
                    }
                }

                var req = new XMLHttpRequest();
                req.addEventListener("load", originReqListener);
                req.open('GET', origin_url);
                req.send();

                // reverse geocode destination
                var dest = directions.getDestination();
                var dest_coords = dest.geometry.coordinates;
                var dest_url = 'https://api.mapbox.com/geocoding/v5/mapbox.places/' + dest_coords[0] + ',' + dest_coords[1] + '.json?access_token=pk.eyJ1Ijoic2FmYXJ0ZWFtMjAyMCIsImEiOiJja2dtbHRsbW4wMWtlMnhxbDNheGJ6OWY5In0.sQWD2q6skgQK31V-ip2Ltg';

                function destReqListener() {
                    var djson = JSON.parse(this.response);
                    var substring = "place"
                    for(let i = 0; i < djson.features.length; i++) {
                        if(djson.features[i].id.includes(substring)) {
                            destination = djson.features[i].place_name;
                            break;
                        }
                    }
                    console.log(start_location);
                    console.log(destination);
                    create_trip(start_location, destination);
                }

                var dreq = new XMLHttpRequest();
                dreq.addEventListener("load", destReqListener);
                dreq.open('GET', dest_url);
                dreq.send();
            });


            // initialize the map canvas to interact with later
            var canvas = map.getCanvasContainer();

            // add user's trip to the database
            var return_dict;
			function create_trip(start_location, destination){
                console.log(start_location + " --> " + destination);
				//display();
				var url = "";
				var req = new XMLHttpRequest();
				req.open('POST', url, true);
                var dict = {'start_location':start_location, 'destination':destination};
				var json_dict = JSON.stringify(dict);
				console.log(json_dict);
				req.send(json_dict);
                /*
				req.onload = function(e){
					//return_dict = JSON.parse(req.body);
                    //console.log(return_dict)
				    //window.location.href = "../directions/";
				}
                */
			}

            console.log(origin_coords + " --> " + dest_coords);
            // have user drag a marker to get suggestions
            var marker = new mapboxgl.Marker({
                draggable: true
            })
                .setLngLat([-122.662323, 45.523751])
                .addTo(map);

            function onDragEnd() {
                var lngLat = marker.getLngLat();
                console.log("lng: " + lngLat.lng + " lat: " + lngLat.lat);
                getSuggestions(lngLat.lng, lngLat.lat);
            }

            marker.on('dragend', onDragEnd);

            // get suggestions
            function getSuggestions(lng, lat) {
                url = 'https://api.tomtom.com/search/2/poiSearch/bar.json?lat=' + lat + '&lon=' + lng + '&radius=1600&categorySet=9379&key=ofA7qZAPku6DpZdRy3h56n5hZZ0g99t9'
                var result;
                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        result = data.results;
                        console.log(result);
                        addSuggestions(result);
                    })
                    .catch(error => console.log(error));
            }

            function addSuggestions(result) {
                // create the suggestions layer
                console.log(count);

                if(count > 0) {
                    console.log("in count if");
                    map.removeLayer('suggestions');
                    map.removeSource('suggestions');
                }

                var suggestions = {
                    'type': 'geojson',
                    'data': {
                        'type': 'FeatureCollection',
                        'features': []
                    }
                }
                
                console.log(suggestions);

                for(let i = 0; i < result.length; i++) {
                    console.log(result[i].poi.name);

                    var newSuggestion = {
                        'type': 'Feature',
                        'properties': {
                            'description': '<strong>' + result[i].poi.name + '</strong>',
                            'icon': 'bar'
                        },
                        'geometry': {
                            'type': 'Point',
                            'coordinates': [result[i].position.lon, result[i].position.lat]
                        }
                    }

                    console.log(newSuggestion);

                    suggestions.data.features[i] = newSuggestion;
                }

                console.log(suggestions);
                map.addSource('suggestions', suggestions);

                // add the suggestions layer
                map.addLayer({
                    'id': 'suggestions',
                    'type': 'symbol',
                    'source': 'suggestions',
                    'layout': {
                        'icon-image': '{icon}-15',
                        'icon-allow-overlap': true
                    }
                });

                count++;
            }

            map.on('click', 'suggestions', function(e) {
                var coordinates = e.features[0].geometry.coordinates.slice();
                var description = e.features[0].properties.description;

                while(Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                    coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
                }

                new mapboxgl.Popup()
                    .setLngLat(coordinates)
                    .setHTML(description)
                    .addTo(map);
            });

            map.on('mouseenter', 'suggestions', function() {
                map.getCanvas().style.cursor = 'pointer';
            });

            map.on('mouseleave', 'suggestions', function() {
                map.getCanvas().style.cursor = '';
            });
        </script>
    </body>
</html>
